<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Child Health Burden – WASH Focus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js and PapaParse from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      /* UNICEF-inspired palette */
      --bg: #f3f8fc;
      --panel-bg: #ffffff;
      --accent: #00aef3;      /* UNICEF blue */
      --accent-soft: #d7efff;
      --text: #1f2933;
      --muted: #5f6c80;
      --border: #c9d5e3;

      /* WASH buckets */
      --wash-core: #e53935;   /* red */
      --wash-ext:  #ffb300;   /* amber */
      --wash-non:  #9e9e9e;   /* grey */
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    header {
      padding: 0.8rem 1.5rem;
      background: var(--panel-bg);
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }
    .brand {
      display: flex;
      align-items: baseline;
      gap: 0.6rem;
    }
    .brand-main {
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--accent);
    }
    .brand-tagline {
      font-size: 0.85rem;
      color: var(--muted);
    }
    header h1 {
      font-size: 1.25rem;
      margin: 0;
    }
    header small {
      display: block;
      font-size: 0.8rem;
      color: var(--muted);
    }

    #app {
      display: flex;
      flex-wrap: wrap;
      min-height: calc(100vh - 60px);
    }
    aside {
      flex: 0 0 290px;
      max-width: 340px;
      padding: 1rem 1.25rem;
      background: var(--panel-bg);
      border-right: 1px solid var(--border);
    }
    main {
      flex: 1 1 0;
      padding: 1rem 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    @media (max-width: 900px) {
      #app { flex-direction: column; }
      aside {
        flex: none;
        max-width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }
    }

    @media (max-width: 600px) {
      canvas {
        height: 260px !important;
      }
    }

    .control-group {
      margin-bottom: 1rem;
    }
    .control-group label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
      font-weight: 600;
    }
    .control-group select,
    .control-group input[type="range"],
    .control-group input[type="text"] {
      width: 100%;
      padding: 0.35rem 0.45rem;
      border-radius: 4px;
      border: 1px solid var(--border);
      font-size: 0.9rem;
      background: #f9fbff;
    }
    .multi-help {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 0.15rem;
    }
    .radio-row,
    .checkbox-col {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.25rem;
    }
    .radio-row label,
    .checkbox-col label {
      font-size: 0.85rem;
      font-weight: 400;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }
    .slider-value {
      font-size: 0.8rem;
      color: var(--muted);
      text-align: right;
      margin-top: 0.1rem;
    }

    button {
      font-size: 0.8rem;
      border-radius: 999px;
      padding: 0.3rem 0.8rem;
      border: 1px solid var(--accent);
      background: var(--accent);
      color: white;
      cursor: pointer;
    }
    button.secondary {
      background: transparent;
      color: var(--accent);
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .panel {
      background: var(--panel-bg);
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 0.75rem 0.9rem 0.95rem;
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
      box-shadow: 0 4px 10px rgba(15, 40, 80, 0.04);
    }
    .panel h2 {
      font-size: 1rem;
      margin: 0 0 0.1rem;
    }
    .panel p {
      margin: 0;
      font-size: 0.8rem;
      color: var(--muted);
    }
    canvas {
      max-width: 100%;
      height: 340px !important;
    }
    #summary {
      font-size: 0.85rem;
      color: var(--text);
      margin-top: 0.25rem;
    }
    #summary strong {
      color: var(--accent);
    }
    footer {
      font-size: 0.75rem;
      color: var(--muted);
      padding-top: 0.25rem;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      font-size: 0.75rem;
      font-weight: 500;
    }
    .status {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 0.5rem;
    }
    .status.error {
      color: #c62828;
    }
    .control-row-inline {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .control-row-inline button {
      flex: 0 0 auto;
    }

    /* Splash screen */
    #splash {
      position: fixed;
      inset: 0;
      background: rgba(9, 30, 66, 0.78);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #splash.hidden {
      display: none;
    }
    .splash-panel {
      background: #ffffff;
      border-radius: 12px;
      max-width: 680px;
      width: 90%;
      max-height: 90vh;
      padding: 1.25rem 1.4rem;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
    }
    .splash-panel h2 {
      margin-top: 0;
      margin-bottom: 0.3rem;
      font-size: 1.1rem;
    }
    .splash-panel p {
      font-size: 0.85rem;
      color: var(--muted);
      margin: 0.25rem 0;
    }
    .splash-panel ul {
      margin: 0.25rem 0 0.4rem;
      padding-left: 1.1rem;
      font-size: 0.82rem;
      color: var(--muted);
    }
    .splash-panel li {
      margin-bottom: 0.2rem;
    }
    .splash-panel strong {
      color: var(--accent);
    }
    .splash-actions {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.6rem;
    }
    .splash-actions label {
      font-size: 0.8rem;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }
  </style>
</head>
<body>
  <!-- Splash / methodology overlay -->
  <div id="splash">
    <div class="splash-panel">
      <h2>Child health burden – WASH-focused prototype</h2>
      <p>
        This prototype uses Global Burden of Disease (GBD 2023) data to show how different causes affect children at different ages,
        and to estimate how much of that burden is linked to water, sanitation and hygiene (WASH).
      </p>
      <ul>
        <li><strong>Data source:</strong> GBD 2023 single-year extract for the latest year available, sex = “Both”. Only child age bands (&lt;28 days to 19 years) are shown here.</li>
        <li><strong>Measures &amp; metrics:</strong> You can switch between DALYs and deaths, and between absolute numbers and percentages. Rate metrics are hidden in this view to avoid confusion with absolute burden.</li>
        <li><strong>WASH Core:</strong> Causes strongly driven by faecal–oral transmission or unsafe excreta management (e.g. diarrhoeal diseases, typhoid, intestinal worms, schistosomiasis, other intestinal infections, invasive non-typhoidal Salmonella).</li>
        <li><strong>WASH Extended:</strong> Conditions where WASH, hygiene and infection prevention &amp; control are important but not the only drivers (e.g. lower and upper respiratory infections, otitis media, neonatal sepsis, maternal sepsis, some skin and urinary tract infections, tetanus).</li>
        <li><strong>Non-WASH:</strong> All other causes, shown to keep the denominator correct and highlight where WASH is <em>not</em> the main lever.</li>
        <li><strong>Interpretation:</strong> Chart 2 highlights which ages are most dominated by WASH-attributable burden; Charts 1 and 3 show which specific causes drive that burden and how they are classified. The mapping is deliberately simple and can be refined for country-specific work.</li>
      </ul>
      <p>
        This is an internal UNICEF analytical tool to support WASH and health dialogue. Values are indicative and should be interpreted together with national surveillance and programme data.
      </p>
      <div class="splash-actions">
        <label>
          <input type="checkbox" id="dontShowSplash" />
          Don’t show this again on this device
        </label>
        <button id="dismissSplashBtn">Start exploring</button>
      </div>
    </div>
  </div>

  <header>
    <div>
      <div class="brand">
        <span class="brand-main">UNICEF</span>
        <span class="brand-tagline">for every child</span>
      </div>
      <h1>Child Health Burden – WASH Focus</h1>
      <small>Exploring GBD 2023 deaths/DALYs by age, cause and WASH attribution</small>
    </div>
  </header>

  <div id="app">
    <aside>
      <div class="status" id="status">Loading data…</div>

      <div class="control-group">
        <label for="countrySelect">Country</label>
        <select id="countrySelect"></select>
      </div>

      <div class="control-group">
        <label for="measureSelect">Measure</label>
        <select id="measureSelect"></select>
      </div>

      <div class="control-group">
        <label for="metricSelect">Metric</label>
        <select id="metricSelect"></select>
      </div>

      <div class="control-group">
        <label for="ageSelect">Child age bands</label>
        <div class="control-row-inline">
          <select id="ageSelect" multiple size="8" style="flex:1 1 0;"></select>
          <button id="selectAllAgesBtn" type="button" class="secondary">All</button>
        </div>
        <div class="multi-help">Hold Ctrl (Windows) or Cmd (Mac) to select multiple bands.</div>
      </div>

      <div class="control-group">
        <label>Display mode (Chart 2)</label>
        <div class="radio-row">
          <label><input type="radio" name="mode" value="absolute" checked /> Absolute burden</label>
          <label><input type="radio" name="mode" value="share" /> WASH share (%)</label>
        </div>
      </div>

      <div class="control-group">
        <label for="topNRange">Top N causes (Charts 1 &amp; 3)</label>
        <input type="range" id="topNRange" min="5" max="25" value="10" />
        <div class="slider-value"><span id="topNValue">10</span> causes</div>
      </div>

      <div class="control-group">
        <label>Include WASH buckets</label>
        <div class="checkbox-col">
          <label><input type="checkbox" name="washBucket" value="WASH Core" checked /> WASH Core</label>
          <label><input type="checkbox" name="washBucket" value="WASH Extended" checked /> WASH Extended</label>
          <label><input type="checkbox" name="washBucket" value="Non-WASH" checked /> Non-WASH</label>
        </div>
      </div>

      <div class="control-group">
        <label for="causeFilter">Filter causes (text)</label>
        <input id="causeFilter" type="text" placeholder="e.g. diarrheal, typhoid, sepsis…" />
      </div>

      <div class="control-group">
        <button id="resetBtn" type="button" class="secondary" style="width:100%;">Reset all filters</button>
      </div>

      <footer>
        CSV expected: <code>IHMEGBD2023.csv</code> in this folder.<br />
        Run <code>python -m http.server</code> and open <code>http://localhost:8000</code>.
      </footer>
    </aside>

    <main>
      <section class="panel">
        <div class="pill">Chart 1 – Causes vs age</div>
        <h2>Top causes by age band (stacked by age)</h2>
        <p>Each bar is a cause. Colours show which age bands carry the burden for the selected country, measure and metric.</p>
        <canvas id="causeAgeChart"></canvas>
      </section>

      <section class="panel">
        <div class="pill">Chart 3 – Causes vs WASH classification</div>
        <h2>Top causes by WASH bucket</h2>
        <p>Each bar is a cause. Colours classify causes into WASH Core, WASH Extended and Non-WASH based on dominant transmission pathways.</p>
        <canvas id="causeWashChart"></canvas>
      </section>

      <section class="panel">
        <div class="pill">Chart 2 – Age vs WASH bucket</div>
        <h2>WASH Core / Extended share by age</h2>
        <p>For each age band, bars split the burden into WASH Core, WASH Extended and Non-WASH causes. Switch between absolute values and percentage splits.</p>
        <canvas id="ageWashChart"></canvas>
        <div id="summary"></div>

        <footer>
          Source: Global Burden of Disease Study 2023 (GBD 2023) Results, Institute for Health Metrics and Evaluation (IHME).<br />
          Internal UNICEF analytical prototype – not for standalone publication.
        </footer>
      </section>
    </main>
  </div>

  <script>
    // ---- CONFIG ----
    const CSV_PATH = "IHMEGBD2023.csv"; // export your Excel to this CSV name

    const CHILD_AGE_ORDER = [
      "<28 days",
      "1-5 months",
      "6-11 months",
      "12-23 months",
      "2-4 years",
      "5-9 years",
      "10-14 years",
      "15-19 years"
    ];

    // WASH Core: strictly WASH-linked GI and intestinal infections
    const WASH_CORE_CAUSES = [
      "Diarrheal diseases",
      "Typhoid fever",
      "Paratyphoid fever",
      "Typhoid and paratyphoid fevers",
      "Ascariasis",
      "Trichuriasis",
      "Hookworm disease",
      "Schistosomiasis",
      "Invasive Non-typhoidal Salmonella (iNTS)",
      "Other intestinal infectious diseases",
      "Intestinal nematode infections"
    ];

    // WASH Extended: strong but partial links to WASH/IPC/hygiene
    const WASH_EXT_CAUSES = [
      "Lower respiratory infections",
      "Upper respiratory infections",
      "Otitis media",
      "Neonatal sepsis and other neonatal infections",
      "Maternal sepsis and other maternal infections",
      "Cellulitis",
      "Other skin and subcutaneous diseases",
      "Tetanus",
      "Urinary tract infections and interstitial nephritis"
    ];

    function getWashBucket(causeName) {
      if (WASH_CORE_CAUSES.includes(causeName)) return "WASH Core";
      if (WASH_EXT_CAUSES.includes(causeName)) return "WASH Extended";
      return "Non-WASH";
    }

    // ---- STATE ----
    let rawData = [];
    let latestYear = null;

    let causeAgeChart = null;
    let ageWashChart = null;
    let causeWashChart = null;

    const els = {
      splash: document.getElementById("splash"),
      dontShowSplash: document.getElementById("dontShowSplash"),
      dismissSplashBtn: document.getElementById("dismissSplashBtn"),

      status: document.getElementById("status"),
      countrySelect: document.getElementById("countrySelect"),
      measureSelect: document.getElementById("measureSelect"),
      metricSelect: document.getElementById("metricSelect"),
      ageSelect: document.getElementById("ageSelect"),
      selectAllAgesBtn: document.getElementById("selectAllAgesBtn"),
      topNRange: document.getElementById("topNRange"),
      topNValue: document.getElementById("topNValue"),
      causeFilter: document.getElementById("causeFilter"),
      resetBtn: document.getElementById("resetBtn"),
      summary: document.getElementById("summary")
    };

    // ---- UTILITIES ----
    function uniqueSorted(arr) {
      return Array.from(new Set(arr)).sort((a, b) => (a > b ? 1 : a < b ? -1 : 0));
    }

    function sortByChildAge(a, b) {
      const ia = CHILD_AGE_ORDER.indexOf(a);
      const ib = CHILD_AGE_ORDER.indexOf(b);
      if (ia === -1 && ib === -1) return a.localeCompare(b);
      if (ia === -1) return 1;
      if (ib === -1) return -1;
      return ia - ib;
    }

    function getSelectedAges() {
      return Array.from(els.ageSelect.options)
        .filter(o => o.selected)
        .map(o => o.value);
    }

    function getMode() {
      const rb = document.querySelector('input[name="mode"]:checked');
      return rb ? rb.value : "absolute";
    }

    function getSelectedBuckets() {
      const checked = Array.from(document.querySelectorAll('input[name="washBucket"]:checked'))
        .map(el => el.value);
      return new Set(checked);
    }

    function buildAgeSuffix(ages) {
      if (!ages || !ages.length) return "";
      const sorted = ages.slice().sort(sortByChildAge);
      if (sorted.length === 1) return ` – age: ${sorted[0]}`;
      if (sorted.length <= 3) return ` – ages: ${sorted.join(", ")}`;
      return ` – ages: ${sorted[0]} to ${sorted[sorted.length - 1]}`;
    }

    function selectAllAges() {
      Array.from(els.ageSelect.options).forEach(o => { o.selected = true; });
    }

    function resetFilters() {
      // Country: default to Malawi if present, else first
      const options = Array.from(els.countrySelect.options);
      let idx = options.findIndex(o => o.value === "Malawi");
      if (idx === -1) idx = 0;
      if (idx >= 0) els.countrySelect.selectedIndex = idx;

      // Measure: DALYs if present, else first
      const measOpts = Array.from(els.measureSelect.options);
      let midx = measOpts.findIndex(o => o.value === "DALYs (Disability-Adjusted Life Years)");
      if (midx === -1) midx = 0;
      if (midx >= 0) els.measureSelect.selectedIndex = midx;

      // Metric: Number if present, else first
      const metOpts = Array.from(els.metricSelect.options);
      let mx = metOpts.findIndex(o => o.value === "Number");
      if (mx === -1) mx = 0;
      if (mx >= 0) els.metricSelect.selectedIndex = mx;

      // Ages: select all
      selectAllAges();

      // Display mode
      const absRB = document.querySelector('input[name="mode"][value="absolute"]');
      if (absRB) absRB.checked = true;

      // Top N
      els.topNRange.value = 10;
      els.topNValue.textContent = "10";

      // WASH buckets: check all
      document.querySelectorAll('input[name="washBucket"]').forEach(cb => cb.checked = true);

      // Cause filter
      els.causeFilter.value = "";

      updateCharts();
    }

    // ---- SPLASH ----
    function initSplash() {
      try {
        const hide = localStorage.getItem("child_wash_splash_hide");
        if (hide === "true") {
          els.splash.classList.add("hidden");
        }
      } catch (e) {
        // ignore localStorage errors
      }

      els.dismissSplashBtn.addEventListener("click", () => {
        els.splash.classList.add("hidden");
        if (els.dontShowSplash.checked) {
          try {
            localStorage.setItem("child_wash_splash_hide", "true");
          } catch (e) {}
        }
      });
    }

    // ---- DATA LOADING ----
    function loadCsv() {
      els.status.textContent = "Loading CSV…";
      Papa.parse(CSV_PATH, {
        download: true,
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: results => {
          if (results.errors && results.errors.length) {
            console.error(results.errors);
          }
          const rows = results.data.filter(row => row.location_name && row.measure_name);

          rows.forEach(r => {
            r.year = Number(r.year);
            r.val = Number(r.val);
          });

          latestYear = rows.reduce((max, r) => isFinite(r.year) && r.year > max ? r.year : max, 0);

          rawData = rows
            .filter(r => r.sex_name === "Both" && r.year === latestYear)
            .map(r => ({
              ...r,
              wash_bucket: getWashBucket(String(r.cause_name))
            }));

          initControls();
          els.status.textContent = `Loaded ${rawData.length.toLocaleString()} rows (year ${latestYear}, sex = Both).`;
        },
        error: err => {
          console.error(err);
          els.status.textContent = "Error loading CSV. Check console.";
          els.status.classList.add("error");
        }
      });
    }

    // ---- CONTROLS INIT ----
    function initControls() {
      const countries = uniqueSorted(rawData.map(r => r.location_name));
      const measures = uniqueSorted(rawData.map(r => r.measure_name));
      const metricsAll = uniqueSorted(rawData.map(r => r.metric_name));
      // Remove Rate (user feedback: confusing)
      let metrics = metricsAll.filter(m => m !== "Rate");
      if (!metrics.length) metrics = metricsAll;

      const ages = uniqueSorted(
        rawData
          .map(r => r.age_name)
          .filter(a => CHILD_AGE_ORDER.includes(a))
      ).sort(sortByChildAge);

      // Country
      els.countrySelect.innerHTML = "";
      countries.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        els.countrySelect.appendChild(opt);
      });

      // Measure
      els.measureSelect.innerHTML = "";
      measures.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        els.measureSelect.appendChild(opt);
      });
      const dalysIndex = measures.indexOf("DALYs (Disability-Adjusted Life Years)");
      if (dalysIndex >= 0) els.measureSelect.selectedIndex = dalysIndex;

      // Metric
      els.metricSelect.innerHTML = "";
      metrics.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        els.metricSelect.appendChild(opt);
      });

      // Ages
      els.ageSelect.innerHTML = "";
      ages.forEach(a => {
        const opt = document.createElement("option");
        opt.value = a;
        opt.textContent = a;
        opt.selected = true;
        els.ageSelect.appendChild(opt);
      });

      // Top N
      els.topNValue.textContent = els.topNRange.value;

      // Event listeners
      els.countrySelect.addEventListener("change", updateCharts);
      els.measureSelect.addEventListener("change", updateCharts);
      els.metricSelect.addEventListener("change", updateCharts);
      els.ageSelect.addEventListener("change", updateCharts);
      els.topNRange.addEventListener("input", () => {
        els.topNValue.textContent = els.topNRange.value;
        updateCharts();
      });
      document.querySelectorAll('input[name="mode"]').forEach(rb => {
        rb.addEventListener("change", updateCharts);
      });
      document.querySelectorAll('input[name="washBucket"]').forEach(cb => {
        cb.addEventListener("change", updateCharts);
      });
      els.causeFilter.addEventListener("input", () => {
        updateCharts();
      });
      els.selectAllAgesBtn.addEventListener("click", () => {
        selectAllAges();
        updateCharts();
      });
      els.resetBtn.addEventListener("click", resetFilters);

      // Initial charts
      updateCharts();
    }

    // ---- FILTERED DATA ----
    function getFilteredData() {
      const country = els.countrySelect.value;
      const measure = els.measureSelect.value;
      const metric = els.metricSelect.value;
      const ages = new Set(getSelectedAges());
      const buckets = getSelectedBuckets();
      const causeFilter = els.causeFilter.value.trim().toLowerCase();

      const subset = rawData.filter(r =>
        r.location_name === country &&
        r.measure_name === measure &&
        r.metric_name === metric &&
        ages.has(r.age_name) &&
        buckets.has(r.wash_bucket) &&
        (!causeFilter || String(r.cause_name).toLowerCase().includes(causeFilter))
      );

      return { country, measure, metric, ages: Array.from(ages), year: latestYear, rows: subset };
    }

    // ---- CHART BUILDERS ----
    function updateCharts() {
      if (!rawData.length) return;

      const mode = getMode();
      const topN = Number(els.topNRange.value);
      const { country, measure, metric, ages, year, rows } = getFilteredData();

      if (!rows.length) {
        if (causeAgeChart) causeAgeChart.destroy();
        if (ageWashChart) ageWashChart.destroy();
        if (causeWashChart) causeWashChart.destroy();
        els.summary.textContent = "No data for this combination.";
        return;
      }

      buildCauseAgeChart(rows, { topN, ages, country, measure, metric, year });
      buildCauseWashChart(rows, { topN, ages, country, measure, metric, year });
      buildAgeWashChart(rows, { mode, ages, country, measure, metric, year });
    }

    function buildCauseAgeChart(rows, ctxInfo) {
      const { topN, ages, country, measure, metric, year } = ctxInfo;

      // aggregate: cause x age
      const causeAgeMap = new Map(); // cause -> { age -> val, total }
      rows.forEach(r => {
        const cause = String(r.cause_name);
        const age = String(r.age_name);
        if (!causeAgeMap.has(cause)) {
          causeAgeMap.set(cause, { totals: {}, total: 0 });
        }
        const obj = causeAgeMap.get(cause);
        const v = Number(r.val) || 0;
        obj.totals[age] = (obj.totals[age] || 0) + v;
        obj.total += v;
      });

      const sortedCauses = Array.from(causeAgeMap.entries())
        .sort((a, b) => b[1].total - a[1].total)
        .slice(0, topN);

      const causeLabels = sortedCauses.map(([cause]) => cause);

      const ageOrder = Array.from(ages).slice().sort(sortByChildAge);

      const datasets = ageOrder.map(age => ({
        label: age,
        data: sortedCauses.map(([_, obj]) => obj.totals[age] || 0),
        stack: "stack1"
      }));

      if (causeAgeChart) causeAgeChart.destroy();

      const ctx = document.getElementById("causeAgeChart").getContext("2d");
      const ageSuffix = buildAgeSuffix(Array.from(ages));

      causeAgeChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: causeLabels,
          datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: "y",
          plugins: {
            legend: {
              position: "top"
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const val = context.parsed.x || 0;
                  const cause = context.label;
                  const age = context.dataset.label;
                  const total = causeAgeMap.get(cause).total || 0;
                  const pct = total ? (val / total) * 100 : 0;
                  return `${age}: ${val.toLocaleString(undefined, { maximumFractionDigits: 2 })} (${pct.toFixed(1)}%)`;
                }
              }
            },
            title: {
              display: true,
              text: `Top ${topN} causes – ${country}, ${measure} (${metric}, ${year})${ageSuffix}`
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: `${measure} – ${metric}`
              }
            },
            y: {
              ticks: {
                autoSkip: false,
                maxTicksLimit: 20
              }
            }
          }
        }
      });
    }

    function buildCauseWashChart(rows, ctxInfo) {
      const { topN, ages, country, measure, metric, year } = ctxInfo;

      // aggregate: cause x wash bucket (over selected ages)
      const causeWashMap = new Map(); // cause -> { buckets: {..}, total }
      rows.forEach(r => {
        const cause = String(r.cause_name);
        const bucket = String(r.wash_bucket);
        if (!causeWashMap.has(cause)) {
          causeWashMap.set(cause, {
            buckets: { "WASH Core": 0, "WASH Extended": 0, "Non-WASH": 0 },
            total: 0
          });
        }
        const obj = causeWashMap.get(cause);
        const v = Number(r.val) || 0;
        obj.buckets[bucket] = (obj.buckets[bucket] || 0) + v;
        obj.total += v;
      });

      const sortedCauses = Array.from(causeWashMap.entries())
        .sort((a, b) => b[1].total - a[1].total)
        .slice(0, topN);

      const causeLabels = sortedCauses.map(([cause]) => cause);

      const buckets = ["WASH Core", "WASH Extended", "Non-WASH"];
      const styles = getComputedStyle(document.documentElement);
      const colors = {
        "WASH Core": styles.getPropertyValue("--wash-core").trim() || "#e53935",
        "WASH Extended": styles.getPropertyValue("--wash-ext").trim() || "#ffb300",
        "Non-WASH": styles.getPropertyValue("--wash-non").trim() || "#9e9e9e"
      };

      const datasets = buckets.map(bucket => ({
        label: bucket,
        data: sortedCauses.map(([_, obj]) => obj.buckets[bucket] || 0),
        backgroundColor: colors[bucket],
        stack: "stack1"
      }));

      if (causeWashChart) causeWashChart.destroy();

      const ctx = document.getElementById("causeWashChart").getContext("2d");
      const ageSuffix = buildAgeSuffix(Array.from(ages));

      causeWashChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: causeLabels,
          datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: "y",
          plugins: {
            legend: {
              position: "top"
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const val = context.parsed.x || 0;
                  const cause = context.label;
                  const bucket = context.dataset.label;
                  const entry = causeWashMap.get(cause) || { total: 0 };
                  const total = entry.total || 0;
                  const pct = total ? (val / total) * 100 : 0;
                  return `${bucket}: ${val.toLocaleString(undefined, { maximumFractionDigits: 2 })} (${pct.toFixed(1)}% of ${cause})`;
                }
              }
            },
            title: {
              display: true,
              text: `Top ${topN} causes by WASH bucket – ${country}, ${measure} (${metric}, ${year})${ageSuffix}`
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: `${measure} – ${metric}`
              }
            },
            y: {
              ticks: { autoSkip: false, maxTicksLimit: 20 }
            }
          }
        }
      });
    }

    function buildAgeWashChart(rows, ctxInfo) {
      const { mode, ages, country, measure, metric, year } = ctxInfo;

      // aggregate by age x wash
      const ageWashMap = new Map(); // age -> { bucket -> val, total }
      rows.forEach(r => {
        const age = String(r.age_name);
        const bucket = String(r.wash_bucket);
        if (!ageWashMap.has(age)) ageWashMap.set(age, { buckets: {}, total: 0 });
        const obj = ageWashMap.get(age);
        const v = Number(r.val) || 0;
        obj.buckets[bucket] = (obj.buckets[bucket] || 0) + v;
        obj.total += v;
      });

      const ageOrder = Array.from(ages).slice().sort(sortByChildAge);

      const buckets = ["WASH Core", "WASH Extended", "Non-WASH"];
      const styles = getComputedStyle(document.documentElement);
      const colors = {
        "WASH Core": styles.getPropertyValue("--wash-core").trim() || "#e53935",
        "WASH Extended": styles.getPropertyValue("--wash-ext").trim() || "#ffb300",
        "Non-WASH": styles.getPropertyValue("--wash-non").trim() || "#9e9e9e"
      };

      const datasets = buckets.map(bucket => ({
        label: bucket,
        data: ageOrder.map(age => {
          const entry = ageWashMap.get(age);
          if (!entry) return 0;
          const rawVal = entry.buckets[bucket] || 0;
          if (mode === "share") {
            const total = entry.total || 0;
            return total ? (rawVal / total) * 100 : 0;
          }
          return rawVal;
        }),
        backgroundColor: colors[bucket],
        stack: "stack1"
      }));

      if (ageWashChart) ageWashChart.destroy();

      const ctx = document.getElementById("ageWashChart").getContext("2d");
      const ageSuffix = buildAgeSuffix(Array.from(ages));

      ageWashChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: ageOrder,
          datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: "y",
          plugins: {
            legend: {
              position: "top"
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const age = context.label;
                  const bucket = context.dataset.label;
                  const val = context.parsed.x || 0;
                  const entry = ageWashMap.get(age) || { total: 0 };
                  const total = entry.total || 0;
                  const pct = mode === "share"
                    ? val
                    : total ? (val / total) * 100 : 0;
                  const valueText = mode === "share"
                    ? `${val.toFixed(1)}%`
                    : val.toLocaleString(undefined, { maximumFractionDigits: 2 });
                  return `${bucket}: ${valueText} (${pct.toFixed(1)}% of ${age})`;
                }
              }
            },
            title: {
              display: true,
              text:
                mode === "share"
                  ? `WASH share by age – ${country}, ${measure} (${metric}, ${year})${ageSuffix}`
                  : `Age-specific burden by WASH bucket – ${country}, ${measure} (${metric}, ${year})${ageSuffix}`
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: mode === "share"
                  ? "Share of age-specific total (%)"
                  : `${measure} – ${metric}`
              },
              min: 0,
              max: mode === "share" ? 100 : undefined
            },
            y: {
              ticks: { autoSkip: false }
            }
          }
        }
      });

      // Summary text
      let core = 0, ext = 0, non = 0;
      ageOrder.forEach(age => {
        const entry = ageWashMap.get(age);
        if (!entry) return;
        core += entry.buckets["WASH Core"] || 0;
        ext += entry.buckets["WASH Extended"] || 0;
        non += entry.buckets["Non-WASH"] || 0;
      });
      const total = core + ext + non;
      let summary = "";
      if (total > 0) {
        const corePct = (core / total) * 100;
        const coreExtPct = ((core + ext) / total) * 100;
        summary =
          `In <strong>${country}</strong>, WASH Core causes account for ` +
          `<strong>${corePct.toFixed(1)}%</strong> of the selected child ${measure.toLowerCase()}, ` +
          `and WASH Core + Extended account for ` +
          `<strong>${coreExtPct.toFixed(1)}%</strong>.`;
      } else {
        summary = "Total burden is zero for the current filters.";
      }
      els.summary.innerHTML = summary;
    }

    // ---- START ----
    document.addEventListener("DOMContentLoaded", () => {
      initSplash();
      loadCsv();
    });
  </script>
</body>
</html>
